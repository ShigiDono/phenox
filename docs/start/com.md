# シリアル通信モジュールとの通信

## 1. 電源の準備

電源に応じて、[電源について](power.md) を参照しながら電源の準備を行って下さい。

## 2. シリアル通信回路のセット

 図 1 の通りにシリアル通信回路をセットし、ホスト PC とシリアル通信回路の間を USB ケーブルで接続します。

写真にある通り、Phenox2の電子回路はむき出しの状態で、筐体による保護などはありません。そのため、他の金属が電子回路に接触した場合、深刻な破壊につながる可能性があります。（例えば、Phenox2をシリアル通信回路や工具の上に無意識に置いてしまうことがしばしば起こり得ます。）このようなことが決して起こらないよう、最大限の配慮をしてください。

また、未然にメイン回路とのショートを防ぐため、シリアル通信回路は図2のように、ビニールテープなどでぐるぐる巻きにしておくことを強くお勧めします。

![図 1 シリアル通信回路の接続] (/img/phenox/serial_comm.png)
<div align="center">図 1 シリアル通信回路の接続 </div>

![図 2 シリアル通信回路をテープで保護する] (/img/phenox/taped_serial.JPG)
<div align="center">図 2 シリアル通信回路をテープで保護する </div>

## 3. minicomのインストールとセットアップ

ホスト PC がLinuxの場合は, minicom を使って、シリアル通信を行います。必要に応じて、ホスト PC に minicom をインストー ルしてください。
```bash
hostpc@ sudo apt-get install minicom
```
また、minicomの設定ファイルをPhenoxLabのWebページよりダウンロードし、ホストPCに配置します。
```bash
hostpc@ wget http://phenoxlab.com/static/minirc.dfl
hostpc@ sudo mv minirc.dfl /etc/minicom/
```
シリアル通信モジュール (FT232RL) とホスト PC を接続すると、`/dev/ttyUSB{+ 数字 }`, `/dev/ttyACM{+ 数字 }` などのデバイスファイルが現れますので、デバイス名に応じて、"minirc.dfl"を書き換えてください。（Phenox2の電源を入れる必要はありません。）
  
次に、minicomを立ち上げます。
```bash
hostpc@ sudo minicom 
```

ホストPCにUbuntu以外のOSを使用する場合、通信設定は、ボーレート=230400bps、1 ストップビット、パリティ無し、ハードウェアコントロール無し、ソフトウェアコントロール無し、に設定してください。
  
## 4. Phenox2の起動
汎用LED0,1を観察しながら電源スイッチを ON にしてください。汎用LED0,1が約2秒間点灯した後に消灯した場合はLinuxのブートに成功しています。この状態でメッセージが表示されない場合は、シリアル通信の設定を見直して下さい。（汎用LED0,1が点灯し続けている場合、SDカードに異常がある可能性があります。その場合は[FAQ](../faq.md)を参照してください。）
``u-boot >``というメッセージが出現し、先に進まない場合は、``run sdboot``と入力してください。

なお、シリアル通信回路を使用する場合は、Phenox を飛行させることはお控え下さい。


# WiFi モジュールでの通信 (phenoxnet)
製品出荷時では、Phenox が自動的にアクセスポイント (phenoxnet) となり、ネットワーク内のホスト PC から、ssh によるログインを受け付けます。この設定は、ユーザーによって Linux の内部を書き 換えることで、変更可能です。

1. 電源に応じて、[電源について](power.md) を参照しながら電源の準備を行って下さい。
2. Wi-Fi モジュール(WLI-UC-GNM)を Phenox の USB ポートに接続してください。
3. 汎用LED0,1を観察しながら電源スイッチを ON にしてください。汎用LED0,1が約2秒間点灯した後に消灯した場合はLinuxのブートに成功しています。（汎用LED0,1が点灯し続けている場合、SDカードに異常がある可能性があります。その場合は[FAQ](../faq.md)を参照してください。）
4. 20秒程度待ち、Wi-Fiモジュールの青いLEDが細かく点滅を始めたら、Phenox2の準備が完了しています。
5. ホスト PC より WiFi ネットワークの検索を行い、SSID が「phenoxnet」であるアクセスポイントを選択し、パスワードに phenoxnet と入力してください。
6. ホスト PC より、以下のコマンドで ssh 接続を行って下さい。初期パスワードは root になり ます。    
```bash
hostpc$ ssh root@192.168.2.1
```
ここで,"-X"オプションを使用すると、X11フォーワーディング機能を受け付けます。

なお、複数の Phenox2 を同時に動作させる場合は、setting/hostapd.conf を変更し、適切な SSID に変 更してください。

# インターネットへの接続
出荷時の設定では、Phenox は Linux 起動時に自分自身がアクセスポイントとなるために hostapd という機能を使用し、phenoxnet を作るという設定を行います。したがって Phenox2 をインター ネットへ接続させるためには、Phenox2 の Linux 起動時に hostapd を起動する機能を無効化し、 ユーザーの用意した Wi-Fi アクセスポイントへ接続させる必要があります。

1. まず、起動時に hostapd を使用する機能を無効化します。hostapd 起動スクリプトを Linux 起動時実行対象から外します。    
```bash
phenox# mv /etc/rc2.d/S20hostapd /etc/rc2.d/refuge
```
2. 次に、Phenox2 をユーザーの用意した WiFi ルーターへ接続し、`wpa supplicant` コマンドで DHCP サーバから IP アドレスを取得します。設定ファイルの一例が `/root/setting/wlan-set-wli-uc.sh` に記載されています。このスクリプトをユーザーの環境に合わせて書き換え、以下のコマンドを実 行してください。
```bash
phenox# source /root/setting/wlan-set-wli-uc.sh
```

各パラメータの意味と設定方法については、インターネット上で `wpa supplicant` コマンドの使用例を参照してください。
